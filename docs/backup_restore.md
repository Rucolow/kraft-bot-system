# KRAFT Botシステム - バックアップ・リストア手順

このドキュメントは、KRAFT分散型Botシステムの重要なデータと設定のバックアップ、およびリストアに関する手順を説明します。データ損失を防ぎ、緊急時にシステムを復旧するために重要です。

---

## 1. はじめに

KRAFT Botシステムは、主に以下のデータと設定ファイルで構成されています。

*   **Firebase Firestore**: ユーザーデータ（残高、XP、レベル、称号、株式保有など）、取引ログ、市場ニュースなどの動的なデータ。
*   **`.env`**: 各Botのトークン、APIキー、管理者IDなどの機密設定。
*   **`config/firebase_credentials.json`**: Firebaseサービスアカウントの秘密鍵。
*   **`shared/kraft_config.py`**: チャンネルID、称号条件、経済システム設定などの一般的なボット設定。

これらのデータは定期的にバックアップし、安全な場所に保管することが推奨されます。

---

## 2. Firebase Firestoreデータのバックアップ

Firebase Firestoreのデータバックアップには、Google Cloud Platform (GCP) のCloud Firestore Export/Import機能を使用します。

### バックアップ手順 (Export)
1.  **Google Cloud Consoleにアクセス**: Firebaseプロジェクトに関連付けられたGoogle Cloud Consoleにログインします。
2.  **Firestoreに移動**: ナビゲーションメニューから「Database」->「Firestore」を選択します。
3.  **エクスポート機能の利用**: 「Backup」タブ（または同等のエクスポート機能）を探し、「Export」または「スケジュールされたエクスポートの作成」を選択します。
4.  **エクスポート設定**: 
    *   **エクスポート先**: Google Cloud Storage (GCS) バケットを指定します。新規にバケットを作成するか、既存のものを使用します。
    *   **エクスポートするコレクション**: すべてのコレクション（`users`, `transactions`, `market_news`など）を選択します。特定のコレクションのみをバックアップする場合は、それらを選択します。
    *   **スケジュール**: 定期的なバックアップのためにスケジュールを設定することを強く推奨します（例: 毎日、毎週）。
5.  **エクスポート実行**: 設定を保存し、エクスポートを開始します。完了には時間がかかる場合があります。

詳細な手順は、Google Cloudの公式ドキュメントを参照してください: [Cloud Firestore のデータのインポートとエクスポート](https://cloud.google.com/firestore/docs/manage-data/export-import)

### リストア手順 (Import)
1.  **Google Cloud Consoleにアクセス**: Firebaseプロジェクトに関連付けられたGoogle Cloud Consoleにログインします。
2.  **Firestoreに移動**: ナビゲーションメニューから「Database」->「Firestore」を選択します。
3.  **インポート機能の利用**: 「Backup」タブ（または同等のインポート機能）を探し、「Import」を選択します。
4.  **インポート設定**: 
    *   **インポート元**: バックアップファイルが保存されているGCSバケットとパスを指定します。
    *   **インポートオプション**: 既存のデータを上書きするか、マージするかなど、慎重に選択してください。通常、完全なリストアのためには既存データを上書きするオプションが適切です。
5.  **インポート実行**: 設定を保存し、インポートを開始します。完了には時間がかかる場合があります。

**重要**: リストア操作は既存のデータを上書きする可能性があるため、非常に慎重に行う必要があります。本番環境でリストアを行う前に、必ずテスト環境で手順を検証してください。

---

## 3. ボット設定ファイルのバックアップ

以下のファイルは、Git管理から除外されているため、手動または自動スクリプトでバックアップする必要があります。

### `.env` ファイル
*   **内容**: `COMMUNITY_BOT_TOKEN`, `CENTRAL_BANK_TOKEN`, `STOCK_MARKET_TOKEN`, `TITLE_BOT_TOKEN`, `CLAUDE_API_KEY`, `ADMIN_USER_IDS` など。
*   **バックアップ方法**: ファイルを安全な場所（暗号化されたストレージ、パスワードマネージャーなど）にコピーして保管します。

### `config/firebase_credentials.json` ファイル
*   **内容**: Firebaseサービスアカウントの秘密鍵。
*   **バックアップ方法**: 同様に、ファイルを安全な場所にコピーして保管します。このファイルが漏洩すると、Firebaseへの不正アクセスにつながる可能性があるため、厳重に管理してください。

### `shared/kraft_config.py` ファイル
*   **内容**: 各種チャンネルID、称号ロール名、経済システム設定など、環境に依存しない設定。
*   **バックアップ方法**: このファイルはGitで管理されている可能性がありますが、念のため重要な変更を加えた際には別途コピーを保存することを検討してください。

### リストア手順
バックアップしたファイルを、元のパスに上書きコピーすることでリストアできます。ボットを再起動すると、新しい設定が適用されます。

---

## 4. バックアップスケジュール推奨

*   **Firebase Firestoreデータ**: 毎日1回、自動エクスポートを設定することを強く推奨します。
*   **設定ファイル (`.env`, `firebase_credentials.json`, `kraft_config.py`)**: 重要な変更を加えた際、または毎週1回など、定期的に手動またはスクリプトでバックアップします。

定期的なバックアップと、バックアップが正しく行われているかの確認は、システムの健全性を保つ上で不可欠です。 